import { useState, useEffect, useRef } from "react";
import { Box, TextField, Button, Typography, IconButton, List, ListItem, ListItemText, Paper, FormControl, InputLabel, MenuItem, Select, Table, TableBody, TableCell, TableContainer, TableHead, TableRow } from "@mui/material";
import UploadFileIcon from "@mui/icons-material/UploadFile";
import AddIcon from "@mui/icons-material/Add";
import DeleteIcon from "@mui/icons-material/Delete";
import { api } from "../../config/config";
import { toast } from "react-toastify";
import { Membre, Point, Presence, PresenceRequest, PointRequest, DocumentRequest } from "../../config/types";

import {
  addConseil,
  addPresence,
  addPoint,
  addPv
} from "./methods";




const AjouterConseil = () => {
  const [nom, setNom] = useState("");
  const [dReunion, setDReunion] = useState("");
  const [membres, setMembres] = useState<Membre[]>([]);
  const [points, setPoints] = useState<PointRequest[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [presences, setPresences] = useState<PresenceRequest[]>([]);
  const [pv, setPv] = useState<File | null>(null)
  const buttonRef = useRef<HTMLButtonElement | null>(null);




  useEffect(() => {
    api.get("/membres/actif").then((response) => {
      const data = response.data as Membre[];
      setMembres(data);

      // Initialiser toutes les pr√©sences avec "Pr√©sent"
      setPresences(
        data.map((m) => ({
          membre: m.id,
          statut: "P"
        }))
      );
    });
  }, []);


  const handleAddPoint = () => {
    const numero = points.length + 1;
    if (inputValue.trim() !== "") {
      const point: PointRequest = { nom: inputValue, numero, documents: [], selectedFile: null };
      setPoints([...points, point]);
      setInputValue("");
    }
  };

  const handleAddDocument = (numero: number) => {
    setPoints(prevPoints => {
      const pointIndex = prevPoints.findIndex(p => p.numero === numero);
      if (pointIndex === -1 || prevPoints[pointIndex].selectedFile === null) {
        return prevPoints;
      }

      const updatedPoints = [...prevPoints];
      updatedPoints[pointIndex] = {
        ...updatedPoints[pointIndex],
        documents: [...updatedPoints[pointIndex].documents, updatedPoints[pointIndex].selectedFile!],
        selectedFile: null
      };

      return updatedPoints;
    });
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, numero: number) => {
    if (e.target.files?.[0]) {
      setPoints(prevPoints => {
        return prevPoints.map(point => {
          if (point.numero === numero) {
            return {
              ...point,
              selectedFile: {
                name: e.target.files![0].name.substring(0, e.target.files![0].name.lastIndexOf('.')),
                file: e.target.files![0],
              }
            };
          }
          return point;
        });
      });
    }
  };


  const handlePVChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.[0]) {
      setPv(e.target.files?.[0]);
    }
  };

  const handleRemovePv = () => {
    setPv(null);
  };


  const handlePresenceChange = (membreId: number, statut: Presence["statut"]) => {
    setPresences((prevPresences) =>
      prevPresences.map((p) =>
        p.membre === membreId
          ? {
            ...p,
            statut,
            document: statut === "D" ? undefined : p.document,
            delegueA: undefined,
          }
          : p
      )
    );
  };


  const handlePresenceDelegueChange = (membreId: number, delegueA?: number) => {

    if (!delegueA) {
      delegueA = undefined
    }


    setPresences(presences.map(p => p.membre === membreId ? { ...p, delegueA } : p));
  };




  const handleFileDelegueChange = (membreId: number, event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files?.[0]) {
      setPresences(presences.map(p => p.membre === membreId ? { ...p, document: event.target.files?.[0] } : p));
    }
  };

  const handleRemovePoint = (numero: number) => {
    const updatedPoints: PointRequest[] = points.filter((point) => point.numero !== numero);

    // R√©organiser les num√©ros apr√®s suppression
    const renumberedPoints = updatedPoints.map((point, i) => ({
      ...point,
      numero: i + 1 // Num√©rotation commence √† 1
    }));

    setPoints(renumberedPoints);
  };
  const handleRemoveDocument = (pointIndex: number, docIndex: number) => {
    const updatedPoints = [...points];
    updatedPoints[pointIndex].documents = updatedPoints[pointIndex].documents.filter((_, i) => i !== docIndex);
    setPoints(updatedPoints);
  };

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();

    //validataion des informations 

    if (presences.every(p => p.statut === "A")) {
      toast.error("Au moins un membre doit √™tre pr√©sent.");
      return;
    }
  
      // V√©rification des pr√©sences
  for (const presence of presences) {
    if (presence.statut === "D") {
      if (!presence.delegueA) {
        toast.error(`Le membre avec l'ID ${presence.membre} est d√©l√©gu√©, mais aucun d√©l√©gataire n'a √©t√© s√©lectionn√©.`);
        return;
      }
      if (!presence.document) {
        toast.error(`Le membre avec l'ID ${presence.membre} est d√©l√©gu√©, mais aucun document de d√©l√©gation n'a √©t√© ajout√©.`);
        return;
      }
    }
  }

    try {
      /* Etapes
      1 - Ajouter le conseil avec son nom et dReunion et r√©cup√©rer l'ID
      2 - Ajouter les pr√©sences et r√©cup√©rer l'ID
      3 - Ajouter les documents de pr√©sence si pr√©sents
      4 - Ajouter les points un par un s'ils existent
      5 - Ajouter les documents des points pour chaque point
      */

      // 1. Ajouter le conseil
      const conseilData = {
        nom,
        dreunion: dReunion

      };
      const conseil = await addConseil(conseilData); // Ajout du conseil et r√©cup√©ration de l'ID

      // 2. Ajouter les pr√©sences
      for (const presence of presences) {
        const addedPresence = await addPresence(conseil.id, presence); // Ajout de chaque pr√©sence
        console.log("Pr√©sence ajout√©e avec succ√®s : ", addedPresence);
      }

      // 4. Ajouter les points un par un
      for (const point of points) {
        await addPoint(conseil.id, point); // Ajout de chaque point

      }

      if(pv){
       await  addPv(conseil.id,pv);

      }

      toast.success("Le conseil et toutes ses informations ont √©t√© ajout√©s avec succ√®s !");
    } catch (error) {
      console.error("Erreur lors de l'ajout du conseil :", error);
      toast.error("Erreur lors de l'ajout du conseil");
    }
  }


  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();  // Emp√™che le comportement par d√©faut de la touche Enter (soumission du formulaire)
      e.stopPropagation(); // Emp√™che la propagation de l'√©v√©nement
      if (buttonRef.current) {
        buttonRef.current.click();
      }
    }
  };






  return (
    <Box p={3} sx={{ mx: "auto", textAlign: "right", direction: "rtl" }}>
      <Typography variant="h4" gutterBottom>
        ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¨ŸÑÿ≥ ÿßŸÑÿ•ÿØÿßÿ±ÿ©
      </Typography>
      <form onSubmit={handleSubmit}>
        <TextField
          fullWidth
          label="ÿßŸÑŸÖÿ¨ŸÑÿ≥"
          value={nom}
          onChange={(e) => setNom(e.target.value)}
          required
          margin="normal"
        />
        <TextField
          fullWidth
          label="ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ¨ŸÑÿ≥"
          type="date"
          value={dReunion}
          onChange={(e) => setDReunion(e.target.value)}
          required
          margin="normal"
          InputLabelProps={{ shrink: true }}
        />

        <Box sx={{ my: 3 }}>
          <Typography variant="h6">ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿπŸÖÿßŸÑ :</Typography>
          <List sx={{ direction: 'rtl' }}>
            {points.map((point) => (
              <Paper key={point.numero} sx={{ p: 2, mb: 2 }}>
                <Box sx={{ position: "relative" }}>
                  <ListItemText primary={`${point.numero}. ${point.nom}`} sx={{ textAlign: 'right' }} />
                  <IconButton
                    color="error"
                    sx={{ position: "absolute", top: 0, left: 0 }}
                    onClick={() => handleRemovePoint(point.numero)}
                    title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜŸÇÿ∑ÿ©"
                  >
                    <DeleteIcon />
                  </IconButton>
                </Box>
                <List sx={{ direction: 'rtl' }}>
                  {point.documents.map((doc, docIndex) => (
                    <ListItem key={docIndex} sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', pl: 2, textAlign: 'right', width: '100%' }}>
                      <ListItemText primary={`üìÑ ${doc.name}`} sx={{ flexGrow: 1 }} />
                      <IconButton color="error"
                        onClick={() => handleRemoveDocument(point.numero, docIndex)}
                        title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ">
                        <DeleteIcon />
                      </IconButton>
                    </ListItem>
                  ))}
                </List>

                <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                  <Button variant="contained" component="label" startIcon={<UploadFileIcon />}
                    sx={{ width: '150px', marginLeft: '20px' }}>
                    ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ
                    <input
                      type="file"
                      accept=".pdf"
                      hidden
                      onChange={(e) => handleFileChange(e, point.numero)}
                    />
                  </Button>
                  <TextField
                    sx={{
                      direction: 'rtl',
                      textAlign: 'right',
                    }}
                    label="ÿ•ÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ"
                    value={point.selectedFile?.name || ""}
                    onChange={(e) =>
                      setPoints(points.map((pt) => pt.numero === point.numero ? {
                        ...pt,
                        selectedFile: { ...pt.selectedFile!, name: e.target.value }
                      } : pt))
                    }

                    disabled={!point.selectedFile}
                    InputLabelProps={{
                      style: {
                        textAlign: 'right',
                      }
                    }}
                  />
                  <IconButton
                    color="success"
                    onClick={() => handleAddDocument(point.numero)}
                    disabled={!point.selectedFile}
                  >
                    <UploadFileIcon />
                  </IconButton>
                  {point.selectedFile?.name && <Typography>{point.selectedFile?.name}</Typography>}

                </Box>
              </Paper>
            ))}
          </List>

          <Box sx={{ display: "flex", gap: 2, mb: 2 }}>
            <TextField
              label="ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿ∑ÿ©"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              fullWidth
              onKeyDown={handleKeyDown}
              variant="outlined"
              size="small"

            />
            <IconButton color="primary" onClick={handleAddPoint} ref={buttonRef}>
              <AddIcon />
            </IconButton>
          </Box>
        </Box>



        <Typography variant="h6">ÿßŸÑÿ≠ÿ∂Ÿàÿ± :</Typography>

        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>ÿßŸÑÿßÿ≥ŸÖ</TableCell>
                <TableCell>ÿßŸÑÿØŸàÿ±</TableCell>
                <TableCell>ÿßŸÑÿ≠ÿ∂Ÿàÿ±</TableCell>
                <TableCell>ÿßŸÑŸÖŸÅŸàÿ∂ ŸÑŸá</TableCell>
                <TableCell>Ÿàÿ´ŸäŸÇÿ© ÿßŸÑÿ™ŸÅŸàŸäÿ∂</TableCell>


              </TableRow>
            </TableHead>
            <TableBody>
              {membres.map((membre) => {
                const presence = presences.find(p => p.membre === membre.id);
                return (
                  <TableRow key={membre.id}>
                    <TableCell>{membre.nom} {membre.prenom}</TableCell>
                    <TableCell>{membre.role}</TableCell>
                    <TableCell>
                      <FormControl fullWidth variant="outlined" size="small">
                        <InputLabel id={`presence-label-${membre.id}`}>ÿßŸÑÿ≠ÿ∂Ÿàÿ±</InputLabel>
                        <Select
                          labelId={`presence-label-${membre.id}`}
                          value={presence?.statut || "P"}
                          onChange={(e) =>
                            handlePresenceChange(membre.id, e.target.value as "P" | "A" | "D")
                          }
                          label="ÿßŸÑÿ≠ÿ∂Ÿàÿ±"
                        >
                          {["P", "A", "D"].map((status) => (
                            <MenuItem key={status} value={status}>
                              {status === "P" ? "ÿ≠ÿßÿ∂ÿ±" : status === "A" ? "ÿ∫ÿßÿ¶ÿ®" : "ÿ™ŸÅŸàŸäÿ∂"}
                            </MenuItem>
                          ))}
                        </Select>
                      </FormControl>


                    </TableCell>




                    <TableCell>
                      <FormControl fullWidth variant="outlined" size="small" >
                        <InputLabel id={`delegue-label-${membre.id}`} shrink={presence?.delegueA ? true : false} >ÿßŸÑŸÖŸÅŸàÿ∂ ŸÑŸá</InputLabel>
                        <Select
                          labelId={`delegue-label-${membre.id}`}
                          value={presence?.delegueA || ""}
                          onChange={(e) => handlePresenceDelegueChange(membre.id, Number(e.target.value))}
                          label="ÿßŸÑŸÖŸÅŸàÿ∂ ŸÑŸá"

                          disabled={presence?.statut != "D"}
                        >
                          <MenuItem value="">
                            <em>ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</em> {/* Option vide ou texte comme "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ" */}
                          </MenuItem>
                          {membres.filter((m) => m.id !== membre.id).map((m) => (
                            <MenuItem key={m.id} value={m.id}>
                              {m.nom} {m.prenom}
                            </MenuItem>
                          ))}
                        </Select>
                      </FormControl>
                    </TableCell>


                    <TableCell>
                      {presence?.statut === "D" && (
                        <>

                          <Button variant="contained" component="label" startIcon={<UploadFileIcon />}>
                            ÿ™ÿ≠ŸÖŸäŸÑ
                            <input type="file" accept=".pdf" hidden onChange={(e) => handleFileDelegueChange(membre.id, e)} />
                          </Button>

                          {presence.document && [
                            <Typography> {presence.document.name}</Typography>
                          ]}

                        </>
                      )}
                    </TableCell>
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </TableContainer>


        <Box  sx={{ display: "flex", justifyContent:'space-between', mb: 2 , marginTop: 2 }}>
<Box>


          <Button variant="contained" component="label" startIcon={<UploadFileIcon />}
            sx={{ width: '250px', marginLeft: '20px' }}>
            ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ≠ÿ∂ÿ± ÿßŸÑŸÖÿ¨ŸÑÿ≥
            <input
              type="file"
              accept=".pdf"
              hidden
              onChange={(e) => handlePVChange(e)}
            />
          </Button>

        {pv && 
        <>{pv.name}</>}



          </Box>


          <IconButton color="error"
            onClick={() => handleRemovePv()}
            title="ÿ≠ÿ∞ŸÅ ŸÖÿ≠ÿ∂ÿ± ÿßŸÑŸÖÿ¨ŸÑÿ≥"
            disabled={!pv}
            
            >
            <DeleteIcon />
          </IconButton>
        </Box>


        <Button type="submit" variant="contained" sx={{ mt: 3 }}>
          ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ¨ŸÑÿ≥
        </Button>
      </form>
    </Box>
  );
};

export default AjouterConseil;
